// Function to completely reset the form
function resetForm() {
    const form = document.getElementById('regForm');
    if (!form) return;
    
    // Reset form fields
    form.reset();
    
    // Reset file inputs
    const fileInputs = form.querySelectorAll('input[type="file"]');
    fileInputs.forEach(input => {
        input.value = '';
    });
    
    // Reset all form sections
    const sections = document.querySelectorAll('.form-section');
    sections.forEach(section => {
        section.classList.remove('active');
    });
    
    // Show first section
    const firstSection = document.getElementById('section-personal');
    if (firstSection) {
        firstSection.classList.add('active');
    }
    
    // Reset progress bar
    updateProgressBar();
    
    // Clear any status messages
    const statusEl = document.getElementById('form-status');
    if (statusEl) {
        statusEl.textContent = '';
        statusEl.className = 'status-message';
        statusEl.style.display = 'none';
    }
    
    // Clear any error messages
    const errorMessages = document.querySelectorAll('.error-message');
    errorMessages.forEach(error => error.remove());
    
    // Remove error classes from fields
    const errorFields = document.querySelectorAll('.error');
    errorFields.forEach(field => field.classList.remove('error'));
    
    console.log('Form has been reset to initial state');
}

// Form submission handler
function handleFormSubmit(e) {
    e.preventDefault();
    console.log('Form submission started');
    
    const form = e.target;
    const submitBtn = form.querySelector('button[type="submit"]');
    const currentSection = document.querySelector('.form-section.active');
    const statusEl = document.getElementById('form-status') || createStatusElement(form);
    
    try {
        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
        
        if (statusEl) {
            statusEl.textContent = 'Saving your registration...';
            statusEl.className = 'status-message processing';
            statusEl.style.display = 'block';
        }

        // Only proceed with form submission if we're on the last step
        if (currentSection && currentSection.id === 'section-confirmation') {
            // Get all form data
            const formData = new FormData(form);
            const registrationData = {};
            
            // Convert FormData to plain object
            for (let [key, value] of formData.entries()) {
                registrationData[key] = value;
            }
            
            // Add timestamp
            registrationData.timestamp = new Date().toISOString();
            
            // Save to localStorage
            saveRegistrationToLocal(registrationData);
            
            // Show success message
            if (statusEl) {
                statusEl.textContent = 'Registration saved successfully!';
                statusEl.className = 'status-message success';
            }
            
            // Reset the form completely
            resetForm();
            
            // Show success message
            showSuccessMessage('Your registration was saved successfully!');
            
        } else {
            // If not on confirmation page, navigate to next section
            const nextSection = currentSection?.nextElementSibling;
            if (nextSection && nextSection.classList.contains('form-section')) {
                navigateToSection(currentSection, nextSection);
            }
        }
    } catch (error) {
        console.error('Form submission error:', error);
        if (statusEl) {
            statusEl.textContent = error.message || 'An error occurred. Please try again.';
            statusEl.className = 'status-message error';
        }
        showError(error.message || 'An error occurred while saving. Please try again.');
    } finally {
        if (submitBtn) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = 'Submit Registration';
        }
    }
}

// Save registration data to localStorage
function saveRegistrationToLocal(registrationData) {
    try {
        // Get existing registrations or initialize empty array
        const registrations = JSON.parse(localStorage.getItem('plumeeRegistrations') || '[]');
        
        // Add new registration
        registrations.push(registrationData);
        
        // Save back to localStorage
        localStorage.setItem('plumeeRegistrations', JSON.stringify(registrations));
        
        console.log('Registration saved to localStorage:', registrationData);
        return true;
    } catch (error) {
        console.error('Error saving to localStorage:', error);
        throw new Error('Failed to save registration data');
    }
}

// Function to load saved registrations
function loadSavedRegistrations() {
    try {
        return JSON.parse(localStorage.getItem('plumeeRegistrations') || '[]');
    } catch (error) {
        console.error('Error loading registrations:', error);
        return [];
    }
}

// Create status element if it doesn't exist
function createStatusElement(form) {
    const statusEl = document.createElement('div');
    statusEl.id = 'form-status';
    statusEl.className = 'status-message';
    form.prepend(statusEl);
    return statusEl;
}

// Add status message styles
function addStatusStyles() {
    if (!document.getElementById('form-status-styles')) {
        const style = document.createElement('style');
        style.id = 'form-status-styles';
        style.textContent = `
            .status-message {
                padding: 12px;
                margin: 15px 0;
                border-radius: 4px;
                font-weight: 500;
                display: none;
            }
            .status-message.processing {
                background-color: #e6f7ff;
                color: #1890ff;
                border: 1px solid #91d5ff;
            }
            .status-message.success {
                background-color: #f6ffed;
                color: #52c41a;
                border: 1px solid #b7eb8f;
            }
            .status-message.error {
                background-color: #fff2f0;
                color: #ff4d4f;
                border: 1px solid #ffccc7;
            }
        `;
        document.head.appendChild(style);
    }
}

// Initialize form when DOM is loaded
function initializeForm() {
    console.log('Initializing form...');
    
    // Add status message styles
    addStatusStyles();
    
    const form = document.getElementById('regForm');
    if (!form) {
        console.error('Form element not found');
        return;
    }
    
    // Add form submission handler
    form.addEventListener('submit', handleFormSubmit);
    
    // Handle navigation buttons
    document.body.addEventListener('click', function(e) {
        const nextBtn = e.target.closest('.btn-next');
        const backBtn = e.target.closest('.btn-back');
        
        // Handle next button
        if (nextBtn) {
            e.preventDefault();
            const currentSection = nextBtn.closest('.form-section');
            const nextSectionId = nextBtn.getAttribute('data-next-section');
            
            if (currentSection && nextSectionId) {
                const nextSection = document.getElementById(nextSectionId);
                if (nextSection) {
                    // Validate current section before proceeding
                    if (validateSection(currentSection)) {
                        navigateToSection(currentSection, nextSection);
                    }
                }
            }
        }
        
        // Handle back button
        if (backBtn) {
            e.preventDefault();
            const currentSection = backBtn.closest('.form-section');
            const prevSectionId = backBtn.getAttribute('data-prev-section');
            
            if (currentSection && prevSectionId) {
                const prevSection = document.getElementById(prevSectionId);
                if (prevSection) {
                    navigateToSection(currentSection, prevSection);
                }
            }
        }
    });
    
    // Initialize progress bar
    updateProgressBar();
}

// Keep your existing helper functions (navigateToSection, validateSection, etc.) as they are
// ...

// Initialize form when document is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeForm);
} else {
    // Small delay to ensure all elements are available
    setTimeout(initializeForm, 100);
}

// Helper function to validate current step
function validateStep(step) {
    // Clear previous error messages
    const existingErrors = step.querySelectorAll('.error-message');
    existingErrors.forEach(error => error.remove());
    
    // Remove error classes from all fields
    const errorFields = step.querySelectorAll('.error');
    errorFields.forEach(field => field.classList.remove('error'));
    
    const requiredFields = step.querySelectorAll('[required]');
    let isValid = true;
    
    requiredFields.forEach(field => {
        // Skip hidden fields (like file inputs with display: none)
        if (field.offsetParent === null) return;
        
        if (!field.value || (field.type === 'checkbox' && !field.checked)) {
            const fieldName = field.getAttribute('data-label') || field.name || field.id || 'This field';
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.textContent = `${fieldName} is required`;
            
            // Insert after the field or its parent
            const parent = field.closest('.form-group') || field.parentNode;
            parent.appendChild(errorMessage);
            
            // Add error class to the field
            field.classList.add('error');
            
            // Scroll to the first error
            if (isValid) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            isValid = false;
            return;
        }
        
        // Additional validation for email fields
        if (field.type === 'email' && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(field.value.trim())) {
            const errorMessage = document.createElement('div');
            errorMessage.className = 'error-message';
            errorMessage.textContent = 'Please enter a valid email address';
            
            const parent = field.closest('.form-group') || field.parentNode;
            parent.appendChild(errorMessage);
            
            field.classList.add('error');
            
            if (isValid) {
                field.focus();
                field.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            isValid = false;
            return;
        }
        
        // Additional validation for phone numbers (if needed)
        if (field.type === 'tel' && field.value.trim() !== '') {
            const phoneRegex = /^[+\d\s\-()]{10,}$/;
            if (!phoneRegex.test(field.value.trim())) {
                const errorMessage = document.createElement('div');
                errorMessage.className = 'error-message';
                errorMessage.textContent = 'Please enter a valid phone number';
                
                const parent = field.closest('.form-group') || field.parentNode;
                parent.appendChild(errorMessage);
                
                field.classList.add('error');
                
                if (isValid) {
                    field.focus();
                    field.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                isValid = false;
                return;
            }
        }
    });
    
// Function to update the registration summary
function updateSummary() {
    const summaryContainer = document.getElementById('registration-summary');
    if (!summaryContainer) return;

    // Get all form data
    const form = document.getElementById('regForm');
    const formData = new FormData(form);
    const summaryData = Object.fromEntries(formData.entries());
    const abstractFile = document.getElementById('abstractFile')?.files[0]?.name || 'No file selected';
    
    // Combine first and last name for display
    const fullName = `${summaryData.firstName || ''} ${summaryData.lastName || ''}`.trim();
    
    // Update summary elements
    const nameElement = document.getElementById('summary-name');
    const emailElement = document.getElementById('summary-email');
    const regTypeElement = document.getElementById('summary-reg-type');
    const participationElement = document.getElementById('summary-participation');
    const topicElement = document.getElementById('summary-topic');
    
    if (nameElement) nameElement.textContent = fullName || 'Not provided';
    if (emailElement) emailElement.textContent = summaryData.email || 'Not provided';
    if (regTypeElement) regTypeElement.textContent = summaryData.registrationType || 'Not specified';
    if (participationElement) participationElement.textContent = summaryData.presentation || 'Not specified';
    if (topicElement) topicElement.textContent = summaryData.topic || 'Not specified';
    
    // Show/hide abstract section based on participation type
    const abstractItem = document.getElementById('summary-abstract-item');
    const abstractElement = document.getElementById('summary-abstract');
    
    if (abstractItem && abstractElement) {
        if (summaryData.presentation === 'paper' || summaryData.presentation === 'poster') {
            abstractItem.style.display = 'flex';
            abstractElement.textContent = abstractFile;
        } else {
            abstractItem.style.display = 'none';
        }
    }
}

// Helper function to update progress bar
function updateProgressBar() {
    const currentStep = document.querySelector('.form-section.active');
    if (!currentStep) return;
    
    const currentStepId = currentStep.id;
    const progressSteps = document.querySelectorAll('.progress-step');
    
    // Reset all steps
    progressSteps.forEach(step => {
        step.classList.remove('active', 'completed');
    });
    
    // Update steps based on current section
    switch (currentStepId) {
        case 'section-personal':
            progressSteps[0].classList.add('active');
            break;
        case 'section-registration':
            progressSteps[0].classList.add('completed');
            progressSteps[1].classList.add('active');
            break;
        case 'section-confirmation':
            progressSteps[0].classList.add('completed');
            progressSteps[1].classList.add('completed');
            progressSteps[2].classList.add('active');
            // Update summary when reaching confirmation
            updateSummary();
            break;
    }
}

// Helper function to show error messages
function showError(message) {
    // Remove any existing error messages first
    const existingErrors = document.querySelectorAll('.error-message');
    existingErrors.forEach(error => error.remove());
    
    // Create error message element
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.style.color = '#dc3545';
    errorDiv.style.margin = '15px 0';
    errorDiv.style.padding = '10px';
    errorDiv.style.border = '1px solid #f5c6cb';
    errorDiv.style.borderRadius = '4px';
    errorDiv.style.backgroundColor = '#f8d7da';
    errorDiv.innerHTML = `
        <i class="fas fa-exclamation-circle"></i>
        <span>${message}</span>
    `;
    
    // Insert after the form
    const form = document.getElementById('regForm');
    if (form) {
        form.parentNode.insertBefore(errorDiv, form.nextSibling);
        // Scroll to the error
        errorDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    
    // Auto-remove error after 5 seconds
    setTimeout(() => {
        if (errorDiv.parentNode) {
            errorDiv.remove();
        }
    }, 5000);
}

function saveRegistration(registrationData, submitBtn, originalBtnText) {
    try {
        console.log('Saving registration:', registrationData);
        
        // Get existing registrations or initialize empty array
        let registrations = [];
        try {
            const storedData = localStorage.getItem('plumee_registrations');
            registrations = storedData ? JSON.parse(storedData) : [];
        } catch (e) {
            console.error('Error parsing stored registrations:', e);
            registrations = [];
        }
        
        // Add new registration
        registrations.push(registrationData);
        
        // Save back to localStorage
        localStorage.setItem('plumee_registrations', JSON.stringify(registrations));
        console.log('Registration saved successfully');
        
        // Show success message
        const successMsg = document.createElement('div');
        successMsg.className = 'success-message';
        successMsg.innerHTML = `
            <div class="success-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="success-content">
                <h3>Registration Successful!</h3>
                <p>Thank you for registering for PLUMEE 2026. Your registration ID is: <strong>${registrationData.id}</strong></p>
                <p>We'll be in touch with more details soon.</p>
            </div>
        `;
        
        // Replace form with success message
        const form = document.getElementById('regForm');
        if (form) {
            form.style.display = 'none';
            form.parentNode.insertBefore(successMsg, form);
        } else {
            document.body.appendChild(successMsg);
        }
        
        // Redirect to thank you page after 5 seconds
        setTimeout(() => {
            window.location.href = 'thank-you.html';
        }, 5000);
        
    } catch (error) {
        console.error('Error saving registration:', error);
        showError('Failed to save your registration. Please try again.');
    } finally {
        if (submitBtn) {
            submitBtn.innerHTML = originalBtnText || 'Submit';
            submitBtn.disabled = false;
        }
    }
}


    // Form submission is already handled in initializeForm()
    
        // Initialize form elements
    const abstractUploadGroup = document.getElementById('abstractUploadGroup');
    const presentationType = document.getElementById('presentation');
    const fileUploadInput = document.getElementById('abstractFile');
    const filePreview = document.getElementById('filePreview');
    const fileUploadContent = document.querySelector('.file-upload-content');
    
    // File upload handling
    if (fileUploadInput) {
        fileUploadInput.addEventListener('change', function(e) {
            const file = this.files[0];
            if (!file) return;
            
            const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
            const maxSize = 5 * 1024 * 1024; // 5MB
            
            // Validate file type
            if (!validTypes.includes(file.type)) {
                showError('Please upload a valid file (PDF or Word document)');
                this.value = '';
                return;
            }
            
            // Validate file size
            if (file.size > maxSize) {
                showError('File size exceeds 5MB limit');
                this.value = '';
                return;
            }
            
            // Show file preview
            const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
            const fileSize = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
            
            filePreview.innerHTML = `
                <div class="file-preview-item">
                    <i class="${getFileIcon(fileType)}"></i>
                    <div class="file-info">
                        <span class="file-name">${fileName}</span>
                        <span class="file-size">${fileSize}</span>
                    </div>
                    <button type="button" class="remove-file" aria-label="Remove file">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            filePreview.style.display = 'flex';
            fileUploadContent.style.display = 'none';
            
            // Add event listener to remove button
            const removeBtn = filePreview.querySelector('.remove-file');
            if (removeBtn) {
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    fileUploadInput.value = '';
                    filePreview.style.display = 'none';
                    fileUploadContent.style.display = 'flex';
                    
                    // Update summary if on confirmation page
                    if (typeof updateSummary === 'function') {
                        updateSummary();
                    }
                });
            }
            
            // Update summary if on confirmation page
            if (typeof updateSummary === 'function') {
                updateSummary();
            }
        }
    });
}

// Show/hide abstract upload based on presentation type
if (presentationType && abstractUploadGroup) {
    const toggleAbstractUpload = () => {
        if (presentationType.value === 'poster' || presentationType.value === 'paper') {
            abstractUploadGroup.style.display = 'block';
        } else {
            abstractUploadGroup.style.display = 'none';
        }
    };
    
    presentationType.addEventListener('change', toggleAbstractUpload);
    
    // Initialize the state
    toggleAbstractUpload();
}

// Initialize navigation buttons if they exist
const prevButtons = document.querySelectorAll('.btn-prev');
const nextButtons = document.querySelectorAll('.btn-next');

prevButtons.forEach(button => {
    button.addEventListener('click', function() {
        const currentStep = document.querySelector('.form-section.active');
        const prevStep = currentStep?.previousElementSibling;
                const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                // Validate file type
                if (!validTypes.includes(fileType)) {
                    showError('Please upload a valid file (PDF or Word document)');
                    fileUploadInput.value = '';
                    return;
                }
                
                // Validate file size
                if (file.size > maxSize) {
                    showError('File size exceeds 5MB limit');
                    fileUploadInput.value = '';
                    return;
                }
                
                // Show file preview
                const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                const fileSize = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
                
                filePreview.innerHTML = `
                    <div class="file-preview-item">
                        <i class="${getFileIcon(fileType)}"></i>
                        <div class="file-info">
                            <span class="file-name">${fileName}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                        <button type="button" class="remove-file" aria-label="Remove file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                filePreview.style.display = 'flex';
                fileUploadContent.style.display = 'none';
                
                // Add event listener to remove button
                const removeBtn = filePreview.querySelector('.remove-file');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        fileUploadInput.value = '';
                        filePreview.style.display = 'none';
                        fileUploadContent.style.display = 'flex';
                    });
                }
            }
        });
    }
    
    // Show/hide abstract upload based on presentation type
    if (presentationType && abstractUploadGroup) {
        const toggleAbstractUpload = () => {
            if (presentationType.value === 'poster' || presentationType.value === 'paper') {
                abstractUploadGroup.style.display = 'block';
            } else {
                abstractUploadGroup.style.display = 'none';
            }
        };
        
        presentationType.addEventListener('change', toggleAbstractUpload);
        
        // Initialize the state
        toggleAbstractUpload();
    }
    
    // Handle file upload preview
    if (fileUploadInput && filePreview && fileUploadContent) {
        fileUploadInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const fileType = file.type;
                const validTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                const maxSize = 5 * 1024 * 1024; // 5MB
                
                // Validate file type
                if (!validTypes.includes(fileType)) {
                    showError('Please upload a valid file (PDF or Word document)');
                    fileUploadInput.value = '';
                    return;
                }
                
                // Validate file size
                if (file.size > maxSize) {
                    showError('File size exceeds 5MB limit');
                    fileUploadInput.value = '';
                    return;
                }
                
                // Show file preview
                const fileName = file.name.length > 25 ? file.name.substring(0, 22) + '...' : file.name;
                const fileSize = (file.size / (1024 * 1024)).toFixed(1) + 'MB';
                
                filePreview.innerHTML = `
                    <div class="file-preview-item">
                        <i class="${getFileIcon(fileType)}"></i>
                        <div class="file-info">
                            <span class="file-name">${fileName}</span>
                            <span class="file-size">${fileSize}</span>
                        </div>
                        <button type="button" class="remove-file" aria-label="Remove file">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
                
                filePreview.style.display = 'flex';
                fileUploadContent.style.display = 'none';
                
                // Add event listener to remove button
                const removeBtn = filePreview.querySelector('.remove-file');
                if (removeBtn) {
                    removeBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        fileUploadInput.value = '';
                        filePreview.style.display = 'none';
                        fileUploadContent.style.display = 'flex';
                        
                        // Update summary if on confirmation page
                        if (typeof updateSummary === 'function') {
                            updateSummary();
                        }
                    });
                }
                
                // Update summary if on confirmation page
                if (typeof updateSummary === 'function') {
                    updateSummary();
                }
            }
        });
    }
    
    // Initialize navigation buttons if they exist
    const prevButtons = document.querySelectorAll('.btn-prev');
    const nextButtons = document.querySelectorAll('.btn-next');
    
    prevButtons.forEach(button => {
        button.addEventListener('click', function() {
            const currentStep = document.querySelector('.form-section.active');
            const prevStep = currentStep?.previousElementSibling;
            
            if (prevStep && prevStep.classList.contains('form-section')) {
                currentStep.classList.remove('active');
                prevStep.classList.add('active');
                
                // Update progress steps
                updateProgressBar(false);
                
                // Scroll to top of the form
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    });
    
    nextButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const form = document.getElementById('regForm');
            if (form) {
                // Create a submit event to trigger the form submission handler
                const submitEvent = new Event('submit', { cancelable: true, bubbles: true });
                form.dispatchEvent(submitEvent);
            }
        });
    });
});

// Navigate to a specific section
function navigateToSection(currentSection, nextSection) {
    if (!currentSection || !nextSection) return false;
    
    // Validate current section if not going to confirmation
    if (nextSection.id !== 'section-confirmation' && !validateSection(currentSection)) {
        return false;
    }
    
    // Add fade-out effect
    currentSection.classList.add('fade-out');
    
    // Wait for animation to complete
    setTimeout(() => {
        currentSection.classList.remove('active', 'fade-out');
        nextSection.classList.add('active');
        
        // Update progress bar
        updateProgressBar();
        
        // Update summary if going to confirmation
        if (nextSection.id === 'section-confirmation') {
            updateSummary();
        }
        
        // Scroll to section
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
    
    return true;
}

// Validate a form section
function validateSection(section) {
    if (!section) return false;
    
    let isValid = true;
    const requiredFields = section.querySelectorAll('[required]');
    
    // Clear previous errors
    section.querySelectorAll('.error-message').forEach(el => el.remove());
    section.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
    
    // Validate required fields
    requiredFields.forEach(field => {
        if (!field.value.trim()) {
            isValid = false;
            field.classList.add('error');
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.textContent = 'This field is required';
            field.parentNode.insertBefore(errorMsg, field.nextSibling);
        } else if (field.type === 'email' && !isValidEmail(field.value)) {
            isValid = false;
            field.classList.add('error');
            const errorMsg = document.createElement('div');
            errorMsg.className = 'error-message';
            errorMsg.textContent = 'Please enter a valid email address';
            field.parentNode.insertBefore(errorMsg, field.nextSibling);
        }
    });
    
    // Scroll to first error if any
    if (!isValid) {
        const firstError = section.querySelector('.error');
        if (firstError) {
            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    return isValid;
}

// Navigation between form sections
function nextSection(currentSectionId, nextSectionId) {
    const currentSection = document.getElementById(currentSectionId);
    const nextSection = document.getElementById(nextSectionId);
    
    if (!currentSection || !nextSection) {
        console.error('Sections not found:', { currentSectionId, nextSectionId });
        return false;
    }
        
        // First, clear any existing error messages
        const existingErrors = currentSection.querySelectorAll('.error-message');
        existingErrors.forEach(error => error.remove());
        
        // Remove error classes
        const errorFields = currentSection.querySelectorAll('.error');
        errorFields.forEach(field => field.classList.remove('error'));
        
        const requiredFields = currentSection.querySelectorAll('[required]');
        let isValid = true;
        
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('error');
                
                // Add error message if not exists
                const errorMsg = document.createElement('div');
                errorMsg.className = 'error-message';
                errorMsg.textContent = 'This field is required';
                field.parentNode.insertBefore(errorMsg, field.nextSibling);
            } else {
                // Additional validation for email field
                if (field.type === 'email' && !isValidEmail(field.value)) {
                    isValid = false;
                    field.classList.add('error');
                    const emailError = document.createElement('div');
                    emailError.className = 'error-message';
                    emailError.textContent = 'Please enter a valid email address';
                    field.parentNode.insertBefore(emailError, field.nextSibling);
                }
            }
        });
        
        if (!isValid) {
            // Scroll to first error
            const firstError = currentSection.querySelector('.error');
            if (firstError) {
                firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            return false;
        }
    }
    
    // If validation passes or going to confirmation, proceed to next section
    const currentSection = document.getElementById(currentSectionId);
    const nextSection = document.getElementById(nextSectionId);
    
    if (!currentSection || !nextSection) {
        console.error('Sections not found:', { currentSectionId, nextSectionId });
        return false;
    }
    
    // Add fade-out effect
    currentSection.classList.add('fade-out');
    
    // Wait for the fade-out animation to complete
    setTimeout(() => {
        currentSection.classList.remove('active', 'fade-out');
        nextSection.classList.add('active');
        
        // Update progress indicator
        updateProgressBar();
        
        // Update summary if going to confirmation section
        if (nextSectionId === 'section-confirmation') {
            updateSummary();
        }
        
        // Scroll to top of the section
        nextSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
    
    return true;
}

function prevSection(currentSectionId, prevSectionId) {
    const currentSection = document.getElementById(currentSectionId);
    const prevSection = document.getElementById(prevSectionId);
    
    if (!currentSection || !prevSection) {
        console.error('Sections not found:', { currentSectionId, prevSectionId });
        return false;
    }
    
    // Add fade-out effect
    currentSection.classList.add('fade-out');
    
    // Wait for the fade-out animation to complete
    setTimeout(() => {
        currentSection.classList.remove('active', 'fade-out');
        prevSection.classList.add('active');
        
        // Update progress indicator
        updateProgressBar();
        
        // Scroll to top of the section
        prevSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
    
    return true;
        return false;
    }
    
    currentSection.classList.remove('active');
    prevSection.classList.add('active');
    
    // Update progress indicator
    updateProgressIndicator(prevSectionId);
    
    // Scroll to top of the section
    prevSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    return true;
}

function updateProgressIndicator(sectionId) {
    const progressSteps = document.querySelectorAll('.progress-step');
    if (!progressSteps.length) {
        console.warn('No progress steps found');
        return;
    }
    
    let activeStep = 1;
    
    switch(sectionId) {
        case 'section-personal':
            activeStep = 1;
            break;
        case 'section-registration':
            activeStep = 2;
            break;
        case 'section-confirmation':
            activeStep = 3;
            break;
        default:
            console.warn('Unknown section ID:', sectionId);
            return;
    }
    
    progressSteps.forEach((step, index) => {
        if (index + 1 <= activeStep) {
            step.classList.add('active');
        } else {
            step.classList.remove('active');
        }
    });
}

// Helper function to validate email format
function isValidEmail(email) {
// Initialize form when document is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeForm);
} else {
  // Small delay to ensure all elements are available
  setTimeout(initializeForm, 100);
}
    updateSummary();
  }
}
